name: Auto Multistream Sync
on:
  schedule:
    - cron: '*/5 * * * *' # Automatically checks every 5 minutes
  workflow_dispatch:      # Allows you to start it manually from your phone/GitHub

jobs:
  restream:
    runs-on: ubuntu-latest
    steps:
      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Check if werewolf3788 is Live
        id: check_live
        run: |
          # Grabbing your Twitch page and looking for the live signal
          # If "isLiveBroadcast" is missing or the page says "offline", we stop.
          CONTENT=$(curl -s https://www.twitch.tv/werewolf3788)
          if [[ "$CONTENT" == *"isLiveBroadcast\":true"* ]]; then
            echo "werewolf3788 is LIVE. Starting relay..."
          else
            echo "werewolf3788 is OFFLINE. Ending job."
            exit 0
          fi

      - name: Cloud Relay to All Platforms
        run: |
          # Hard limit: 10740 seconds = 2 hours and 59 minutes
          # Uses Florida-specific ingest (mia05) for the lowest latency
          timeout 10740s ffmpeg -i "rtmp://mia05.contribute.live-video.net/app/${{ secrets.TWITCH_KEY }}" \
            -c copy -f flv "${{ secrets.RESTREAM_URL }}/${{ secrets.RESTREAM_KEY }}" \
            -c copy -f flv "rtmp://a.rtmp.youtube.com/live2/${{ secrets.YOUTUBE_KEY }}" \
            -c copy -f flv "rtmp://fa637.kick.com/app/${{ secrets.KICK_KEY }}" \
            -c copy -f flv "rtmp://live.trovo.live/live/${{ secrets.TROVO_KEY }}" \
            -c copy -f flv "rtmps://live-api-s.facebook.com:443/rtmp/${{ secrets.FACEBOOK_KEY }}"
